---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import ArchiveCard from "../components/ArchiveCard.astro";
import { calculateReadingTime } from "../utils/readingTime";

const allPosts = await getCollection("posts");
const topics = [...new Set(allPosts.map((post) => post.data.category))];

const formatDate = (date: Date) => {
    return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
    });
};

// Initial state for progress bar (example: 12 posts out of 20)
// In a real app, this would be dynamic.
const totalArticlesCount = 50; // Mock total
const currentArticlesCount = allPosts.length;
const progressPercentage = (currentArticlesCount / totalArticlesCount) * 100;
---

<Layout title="Article Archive | DimonBlog">
    <Header />

    <main class="flex-1 flex justify-center py-8 px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col w-full max-w-[1200px] gap-8">
            <!-- Title Section -->
            <div
                class="flex flex-col gap-4 border-b border-slate-200 dark:border-[#224249] pb-8"
            >
                <h1
                    class="text-slate-900 dark:text-white text-4xl md:text-5xl font-black leading-tight tracking-[-0.033em]"
                >
                    Article Archives
                </h1>
                <p
                    class="text-slate-600 dark:text-[#90c1cb] text-lg font-normal leading-normal max-w-2xl"
                >
                    Explore the latest insights in programming, cybersecurity,
                    data science, and AI. Stay ahead of the curve.
                </p>
            </div>

            <!-- Filters & Sorting -->
            <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
            >
                <div class="flex gap-2 flex-wrap" id="topic-filters">
                    <button
                        class="topic-filter flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-white dark:bg-background-input hover:bg-slate-100 dark:hover:bg-[#2a4f57] border border-slate-200 dark:border-transparent hover:border-primary/50 dark:hover:border-primary/30 px-4 transition-all group active"
                        data-topic="all"
                    >
                        <span
                            class="text-slate-700 dark:text-white text-sm font-medium"
                            >All Topics</span
                        >
                    </button>
                    {
                        topics.map((topic) => (
                            <button
                                class="topic-filter flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-white dark:bg-background-input hover:bg-slate-100 dark:hover:bg-[#2a4f57] border border-slate-200 dark:border-transparent hover:border-primary/50 dark:hover:border-primary/30 px-4 transition-all group"
                                data-topic={topic}
                            >
                                <span class="text-slate-700 dark:text-white text-sm font-medium">
                                    {topic}
                                </span>
                            </button>
                        ))
                    }
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-slate-500 dark:text-[#90c1cb] text-sm"
                        >Sort by:</span
                    >
                    <button
                        class="flex items-center gap-1 text-slate-700 dark:text-white text-sm font-medium hover:text-primary"
                        id="sort-toggle"
                    >
                        <span id="sort-label">Newest</span>
                        <span class="material-symbols-outlined text-[20px]"
                            >expand_more</span
                        >
                    </button>
                </div>
            </div>

            <!-- Article Grid -->
            <div
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 opacity-100 transition-opacity duration-300"
                id="archive-grid"
            >
                {
                    allPosts.map((post) => (
                        <div
                            class="archive-item h-full"
                            data-topic={post.data.category}
                            data-date={post.data.pubDate.getTime()}
                            data-tags={
                                post.data.tags?.join(",").toLowerCase() || ""
                            }
                        >
                            <ArchiveCard
                                title={post.data.title}
                                description={post.data.description}
                                image={post.data.image}
                                category={post.data.category}
                                date={formatDate(post.data.pubDate)}
                                readTime={
                                    post.data.readTime ||
                                    calculateReadingTime(post.body)
                                }
                                slug={post.slug}
                            />
                        </div>
                    ))
                }
            </div>

            <!-- Pagination Section -->
            <div
                class="flex flex-col items-center justify-center gap-6 pt-12 pb-8 border-t border-slate-200 dark:border-[#224249] mt-8"
            >
                <div class="flex items-center gap-2" id="pagination-controls">
                    <button
                        id="prev-page"
                        class="flex items-center justify-center w-10 h-10 rounded-lg bg-white dark:bg-background-input border border-slate-200 dark:border-primary/20 text-slate-600 dark:text-white hover:bg-primary/10 hover:border-primary transition-all disabled:opacity-30 disabled:cursor-not-allowed group"
                        aria-label="Previous page"
                    >
                        <span
                            class="material-symbols-outlined text-[20px] group-hover:-translate-x-0.5 transition-transform"
                            >chevron_left</span
                        >
                    </button>

                    <div id="page-numbers" class="flex items-center gap-2">
                        <!-- Numbers will be injected here -->
                    </div>

                    <button
                        id="next-page"
                        class="flex items-center justify-center w-10 h-10 rounded-lg bg-white dark:bg-background-input border border-slate-200 dark:border-primary/20 text-slate-600 dark:text-white hover:bg-primary/10 hover:border-primary transition-all disabled:opacity-30 disabled:cursor-not-allowed group"
                        aria-label="Next page"
                    >
                        <span
                            class="material-symbols-outlined text-[20px] group-hover:translate-x-0.5 transition-transform"
                            >chevron_right</span
                        >
                    </button>
                </div>
                <div
                    class="text-xs font-medium text-slate-500 dark:text-[#90c1cb] uppercase tracking-widest"
                    id="pagination-info"
                >
                    Page 1 of 1
                </div>
            </div>
        </div>
    </main>

    <Footer />
</Layout>

<script>
    const topicButtons = document.querySelectorAll(".topic-filter");
    const archiveGrid = document.getElementById("archive-grid");
    const archiveItems = document.querySelectorAll(
        ".archive-item",
    ) as NodeListOf<HTMLElement>;
    const sortToggle = document.getElementById("sort-toggle");
    const sortLabel = document.getElementById("sort-label");

    // Pagination Elements
    const prevBtn = document.getElementById("prev-page") as HTMLButtonElement;
    const nextBtn = document.getElementById("next-page") as HTMLButtonElement;
    const pageNumbersContainer = document.getElementById("page-numbers");
    const paginationInfo = document.getElementById("pagination-info");

    // Check for query parameters on load
    const urlParams = new URLSearchParams(window.location.search);
    const initialTopic = urlParams.get("topic");
    const initialTag = urlParams.get("tag");
    const initialPage = parseInt(urlParams.get("page") || "1");

    let currentSort = "newest";
    let currentTopic = initialTopic || "all";
    let currentTag: string | null = initialTag;
    let currentPage = initialPage;
    const itemsPerPage = 6;

    // Filtered items based on topic and tag
    let filteredItems: HTMLElement[] = Array.from(archiveItems);

    const updateUrl = () => {
        const params = new URLSearchParams();
        if (currentTopic && currentTopic !== "all")
            params.set("topic", currentTopic);
        if (currentTag) params.set("tag", currentTag);
        if (currentPage > 1) params.set("page", currentPage.toString());

        const newUrl = `${window.location.pathname}${params.toString() ? "?" + params.toString() : ""}`;
        window.history.pushState(
            { topic: currentTopic, tag: currentTag, page: currentPage },
            "",
            newUrl,
        );
    };

    const updatePagination = (scrollToTop = false, animate = true) => {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage) || 1;
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        // Update Info
        if (paginationInfo)
            paginationInfo.textContent = `Page ${currentPage} of ${totalPages}`;

        // Update Buttons
        if (prevBtn) prevBtn.disabled = currentPage === 1;
        if (nextBtn) nextBtn.disabled = currentPage === totalPages;

        // Render Page Numbers
        if (pageNumbersContainer) {
            pageNumbersContainer.innerHTML = "";
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.className = `w-10 h-10 rounded-lg border transition-all text-sm font-bold ${
                    i === currentPage
                        ? "bg-primary text-background-dark border-primary shadow-[0_0_15px_rgba(13,204,242,0.3)]"
                        : "bg-white dark:bg-background-input border-slate-200 dark:border-primary/20 text-slate-600 dark:text-white hover:bg-slate-100 dark:hover:bg-primary/10 hover:border-primary"
                }`;
                btn.textContent = i.toString();
                btn.addEventListener("click", () => {
                    currentPage = i;
                    updatePagination(true, true);
                    updateUrl();
                });
                pageNumbersContainer.appendChild(btn);
            }
        }

        renderCurrentPage(scrollToTop, animate);
    };

    const renderCurrentPage = (scrollToTop = false, animate = true) => {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;

        const updateDOM = () => {
            if (scrollToTop) {
                window.scrollTo(0, 0);
            }

            archiveItems.forEach((item) => (item.style.display = "none"));

            filteredItems.forEach((item, index) => {
                if (index >= start && index < end) {
                    item.style.display = "block";
                }
            });
        };

        if (animate) {
            // Fade effect
            if (archiveGrid) archiveGrid.style.opacity = "0";
            setTimeout(() => {
                updateDOM();
                if (archiveGrid) archiveGrid.style.opacity = "1";
            }, 200);
        } else {
            // Instant update
            updateDOM();
            if (archiveGrid) archiveGrid.style.opacity = "1";
        }
    };

    const applyFilter = (
        topic: string | null,
        tag: string | null = null,
        resetPage = true,
        animate = true,
    ) => {
        if (!topic) topic = "all";
        currentTopic = topic;
        currentTag = tag;

        // Update active states
        topicButtons.forEach((btn) => {
            const btnTopic = btn.getAttribute("data-topic");
            if (btnTopic === topic) {
                btn.classList.add("active");
            } else {
                btn.classList.remove("active");
            }
        });

        // Filter items
        filteredItems = Array.from(archiveItems).filter((item) => {
            const matchesTopic =
                topic === "all" || item.getAttribute("data-topic") === topic;

            if (tag) {
                const itemTags =
                    item.getAttribute("data-tags")?.split(",") || [];
                return matchesTopic && itemTags.includes(tag.toLowerCase());
            }

            return matchesTopic;
        });

        if (resetPage) {
            currentPage = 1;
        }
        updatePagination(resetPage, animate);
    };

    // Event Listeners
    prevBtn?.addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            updatePagination(true, true);
            updateUrl();
        }
    });

    nextBtn?.addEventListener("click", () => {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updatePagination(true, true);
            updateUrl();
        }
    });

    // Initial load
    applyFilter(initialTopic, initialTag, false, false);

    // Topic Filtering Click Events
    topicButtons.forEach((button) => {
        button.addEventListener("click", () => {
            const topic = button.getAttribute("data-topic");
            applyFilter(topic, currentTag, true, true);
            updateUrl();
        });
    });

    // Sorting
    sortToggle?.addEventListener("click", () => {
        currentSort = currentSort === "newest" ? "oldest" : "newest";
        if (sortLabel)
            sortLabel.textContent =
                currentSort.charAt(0).toUpperCase() + currentSort.slice(1);

        const sortedItems = Array.from(archiveItems).sort((a, b) => {
            const dateA = parseInt(a.getAttribute("data-date") || "0");
            const dateB = parseInt(b.getAttribute("data-date") || "0");
            return currentSort === "newest" ? dateB - dateA : dateA - dateB;
        });

        // Update items in the DOM and re-filter
        sortedItems.forEach((item) => archiveGrid?.appendChild(item));
        applyFilter(currentTopic, currentTag, false, true); // Keep page, animate sort
    });
</script>

<style>
    @reference "../styles/global.css";

    .topic-filter.active {
        @apply bg-primary text-background-dark font-bold;
        box-shadow: 0 0 15px rgba(13, 204, 242, 0.3);
    }

    #archive-grid {
        transition-property: opacity;
    }
</style>
