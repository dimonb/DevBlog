---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import PostSidebarLeft from "../../components/PostSidebarLeft.astro";
import PostSidebarRight from "../../components/PostSidebarRight.astro";
import Remark42 from "../../components/Remark42.astro";
import { calculateReadingTime } from "../../utils/readingTime";

export async function getStaticPaths() {
    const posts = await getCollection("posts");
    return posts.map((post) => ({
        params: { slug: post.slug },
        props: { post },
    }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const allPosts = await getCollection("posts");

// Scoring system for relatedness
const relatedPostsScored = allPosts
    .filter((p) => p.slug !== post.slug)
    .map((p) => {
        let score = 0;

        // 1. Shared tags (Highest weight)
        if (p.data.tags && post.data.tags) {
            const sharedTags = p.data.tags.filter((tag) =>
                post.data.tags.includes(tag),
            );
            score += sharedTags.length * 5;
        }

        // 2. Shared category
        if (p.data.category === post.data.category) {
            score += 3;
        }

        // 3. Shared subCategory
        if (
            p.data.subCategory &&
            post.data.subCategory &&
            p.data.subCategory === post.data.subCategory
        ) {
            score += 2;
        }

        return { post: p, score };
    })
    .filter((item) => item.score > 0)
    .sort(
        (a, b) =>
            b.score - a.score ||
            b.post.data.pubDate.valueOf() - a.post.data.pubDate.valueOf(),
    )
    .slice(0, 3);

// Fallback to latest posts if no related posts found
let finalRelatedPosts = relatedPostsScored.map((item) => item.post);
if (finalRelatedPosts.length < 3) {
    const fallbackPosts = allPosts
        .filter(
            (p) =>
                p.slug !== post.slug &&
                !finalRelatedPosts.find((rp) => rp.slug === p.slug),
        )
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
        .slice(0, 3 - finalRelatedPosts.length);
    finalRelatedPosts = [...finalRelatedPosts, ...fallbackPosts];
}

const formattedRelatedPosts = finalRelatedPosts.map((p) => ({
    title: p.data.title,
    date: p.data.pubDate.toLocaleDateString("en-US", {
        month: "short",
        day: "2-digit",
        year: "numeric",
    }),
    readTime: p.data.readTime || calculateReadingTime(p.body),
    image: p.data.image,
    slug: p.slug,
}));

const formatDate = (date: Date) => {
    return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
    });
};
---

<Layout title={`${post.data.title} | DevBlog`}>
    <Header />

    <main class="relative flex min-h-screen flex-col">
        <div
            class="w-full max-w-[1440px] mx-auto flex-1 px-4 sm:px-6 lg:px-8 py-10"
        >
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 relative">
                <!-- Article Content -->
                <article class="col-span-1 lg:col-start-2 lg:col-span-8 w-full">
                    <div class="mb-10">
                        <div class="flex flex-wrap gap-2 mb-6">
                            <span
                                class="inline-flex items-center rounded-lg bg-primary/10 px-3 py-1 text-sm font-medium text-primary ring-1 ring-inset ring-primary/20"
                            >
                                {post.data.category}
                            </span>
                            {
                                post.data.subCategory && (
                                    <span class="inline-flex items-center rounded-lg bg-slate-100 dark:bg-[#224249]/50 px-3 py-1 text-sm font-medium text-slate-600 dark:text-slate-300">
                                        {post.data.subCategory}
                                    </span>
                                )
                            }
                        </div>

                        <h1
                            class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight text-slate-900 dark:text-white leading-[1.15] mb-6"
                        >
                            {post.data.title}
                        </h1>

                        <div
                            class="flex items-center gap-4 py-4 border-b border-slate-200 dark:border-[#224249]"
                        >
                            <div class="relative">
                                {
                                    post.data.authorImage && (
                                        <img
                                            src={post.data.authorImage}
                                            alt={post.data.author}
                                            class="h-12 w-12 rounded-full ring-2 ring-white dark:ring-[#102023] object-cover"
                                        />
                                    )
                                }
                                <span
                                    class="absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-green-500 ring-2 ring-white dark:ring-[#102023]"
                                ></span>
                            </div>
                            <div class="flex flex-col">
                                <span
                                    class="text-sm font-bold text-slate-900 dark:text-white"
                                    >{post.data.author}</span
                                >
                                <div
                                    class="flex items-center gap-2 text-sm text-slate-500 dark:text-[#90c1cb]"
                                >
                                    <span>{formatDate(post.data.pubDate)}</span>
                                    <span>â€¢</span>
                                    <span
                                        >{
                                            post.data.readTime ||
                                                calculateReadingTime(post.body)
                                        }</span
                                    >
                                </div>
                            </div>
                            <div class="ml-auto flex gap-2">
                                <button
                                    class="rounded-full p-2 text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors lg:hidden"
                                >
                                    <span class="material-symbols-outlined"
                                        >share</span
                                    >
                                </button>
                                <button
                                    class="rounded-full p-2 text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors lg:hidden"
                                >
                                    <span class="material-symbols-outlined"
                                        >bookmark</span
                                    >
                                </button>
                            </div>
                        </div>
                    </div>

                    <div
                        class="prose prose-lg dark:prose-invert max-w-none prose-headings:font-bold prose-headings:tracking-tight prose-a:text-primary prose-a:no-underline hover:prose-a:underline prose-img:rounded-xl"
                    >
                        <Content />
                    </div>

                    <div
                        class="mt-12 pt-8 border-t border-slate-200 dark:border-[#224249]"
                    >
                        <div
                            class="flex flex-col sm:flex-row justify-between items-center gap-6"
                        >
                            <div class="flex flex-wrap gap-2">
                                <span
                                    class="text-sm text-slate-500 dark:text-slate-400 mr-2 self-center"
                                    >Tags:</span
                                >
                                {
                                    post.data.tags.map((tag) => (
                                        <a
                                            href={`/archive?tag=${tag}`}
                                            class="px-3 py-1 rounded-full bg-slate-100 dark:bg-surface-dark text-xs font-medium text-slate-600 dark:text-slate-300 hover:bg-primary/20 hover:text-primary transition-colors cursor-pointer"
                                        >
                                            #{tag}
                                        </a>
                                    ))
                                }
                            </div>
                            <!-- Social Share -->
                            <div class="flex items-center gap-4">
                                <span
                                    class="text-sm font-medium text-slate-900 dark:text-white"
                                    >Share Article</span
                                >
                                <div class="flex gap-2">
                                    <button
                                        class="size-8 flex items-center justify-center rounded-full bg-slate-100 dark:bg-surface-dark text-slate-600 dark:text-slate-300 hover:bg-[#1da1f2] hover:text-white transition-all"
                                    >
                                        <svg
                                            class="w-4 h-4"
                                            fill="currentColor"
                                            viewBox="0 0 24 24"
                                            ><path
                                                d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"
                                            ></path></svg
                                        >
                                    </button>
                                    <button
                                        class="size-8 flex items-center justify-center rounded-full bg-slate-100 dark:bg-surface-dark text-slate-600 dark:text-slate-300 hover:bg-[#0a66c2] hover:text-white transition-all"
                                    >
                                        <svg
                                            class="w-4 h-4"
                                            fill="currentColor"
                                            viewBox="0 0 24 24"
                                            ><path
                                                d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"
                                            ></path></svg
                                        >
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>

                <!-- Right Sidebar -->
                <PostSidebarRight
                    headings={headings}
                    relatedPosts={formattedRelatedPosts}
                />

                <div class="col-span-1 lg:col-start-2 lg:col-span-8 w-full">
                    <Remark42 />
                </div>
            </div>
        </div>
    </main>

    <Footer />

    <script>
        // Copy to clipboard functionality
        const copyButtons = document.querySelectorAll(".copy-button");
        copyButtons.forEach((button) => {
            button.addEventListener("click", async () => {
                // Find the nearest code block relative to the button's wrapper
                const wrapper = button.closest(".code-block-wrapper");
                const codeElement = wrapper?.querySelector("pre");
                const code = codeElement?.innerText || "";

                const textSpan = button.querySelector("span:last-child");
                const iconSpan = button.querySelector(
                    ".material-symbols-outlined",
                );

                if (code && textSpan && iconSpan) {
                    try {
                        await navigator.clipboard.writeText(code);

                        // Visual feedback
                        textSpan.textContent = "Copied!";
                        iconSpan.textContent = "check";
                        button.classList.add("text-primary");

                        setTimeout(() => {
                            textSpan.textContent = "Copy";
                            iconSpan.textContent = "content_copy";
                            button.classList.remove("text-primary");
                        }, 2000);
                    } catch (err) {
                        console.error("Failed to copy text: ", err);
                    }
                }
            });
        });
    </script>
</Layout>
